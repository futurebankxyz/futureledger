{"version":3,"sources":["../src/subspace.js"],"names":["ReplaySubject","BehaviorSubject","Subject","distinctUntilChanged","map","equal","Database","NullDatabase","Events","Web3Eth","isAddress","stripHexPrefix","hexToDec","EventSyncer","LogSyncer","hash","Subspace","constructor","provider","options","on","console","warn","events","web3","refreshLastNBlocks","callInterval","dbFilename","disableDatabase","networkId","undefined","isWebsocketProvider","disableSubscriptions","latestBlockNumber","latestGasPrice","latestBlock","latest10Blocks","subjects","newBlocksSubscription","intervalTracker","callables","init","resolve","reject","_db","eventSyncer","logSyncer","net","getId","then","netId","block","getBlock","gasPrice","getGasPrice","number","minBlock","Math","max","i","push","all","_initNewBlocksSubscription","_initCallInterval","contract","contractInstance","Error","address","deployedAddress","abi","jsonInterface","abiDefinition","from","defaultAddress","defaultAccount","gas","SubspaceContract","Contract","accounts","getAccounts","trackEvent","eventName","filterConditionsOrCb","ev","x","type","name","track","trackProperty","propName","methodArgs","callArgs","methods","methodName","oldFunc","_this","newFunc","txObject","apply","arguments","trackBalance","erc20Address","filterConditions","subjectHash","deleteFrom","returnSub","prop","pipe","newValues","p","clearDB","collection","trackLogs","inputsABI","subscribe","err","result","error","fn","subject","method","callContractMethod","call","next","a","b","_addDistinctCallable","trackAttribute","cbBuilder","subjectArg","sub","cb","trackBlock","blockCB","length","shift","catch","trackBlockNumber","blockNumberCB","getBlockNumber","blockNumber","trackGasPrice","gasPriceCB","trackAverageBlocktime","avgTimeCB","times","time","timestamp","average","round","callFn","getBalance","balance","data","to","close","clearInterval","unsubscribe"],"mappings":"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","sourcesContent":["import { ReplaySubject, BehaviorSubject, Subject } from 'rxjs';\nimport { distinctUntilChanged, map } from 'rxjs/operators';\nimport equal from 'fast-deep-equal';\nimport Database  from './database/database.js';\nimport NullDatabase  from './database/nullDatabase.js';\nimport Events from 'events';\nimport Web3Eth from 'web3-eth';\nimport {isAddress} from './utils';\nimport stripHexPrefix from 'strip-hex-prefix';\nimport {hexToDec} from 'hex2dec';\nimport EventSyncer from './eventSyncer';\nimport LogSyncer from './logSyncer';\nimport hash from 'object-hash';\n\nexport default class Subspace {\n\n  constructor(provider, options = {}) {\n    if (!provider.on) {\n      // https://github.com/ethereum/web3.js/blob/1.x/packages/web3-core-subscriptions/src/subscription.js#L205\n      console.warn(\"subspace: the current provider doesn't support subscriptions. Falling back to http polling\");\n    }\n\n    this.events = new Events();\n    this.web3 = new Web3Eth(provider);\n\n    this.options = {};\n    this.options.refreshLastNBlocks = options.refreshLastNBlocks || 12;\n    this.options.callInterval = options.callInterval || 0;\n    this.options.dbFilename = options.dbFilename || 'subspace.db';\n    this.disableDatabase = options.disableDatabase;\n    this.networkId = undefined;\n    this.isWebsocketProvider = options.disableSubscriptions ? false : !!provider.on;\n\n    // Stats\n    this.latestBlockNumber = undefined;\n    this.latestGasPrice = undefined;\n    this.latestBlock = undefined;\n    this.latest10Blocks = [];\n\n    this.subjects = {};\n\n    this.newBlocksSubscription = null;\n    this.intervalTracker = null;\n    this.callables = [];\n  }\n\n  init() {\n    return new Promise(async (resolve, reject) => {\n      if (this.disableDatabase === true) {\n        this._db = new NullDatabase(\"\", this.events);\n      } else {\n        this._db = new Database(this.options.dbFilename, this.events);\n      }\n      this.eventSyncer = new EventSyncer(this.web3, this.events, this._db, this.isWebsocketProvider);\n      this.logSyncer = new LogSyncer(this.web3, this.events, this._db);\n\n      this.web3.net.getId().then(netId => {\n        this.networkId = netId;\n      });\n\n\n      const block = await this.web3.getBlock('latest');\n      const gasPrice = await this.web3.getGasPrice();\n\n      // Preload <= 10 blocks to calculate avg block time\n      if(block.number !== 0){\n        const minBlock = Math.max(0, block.number - 9);\n        for(let i = minBlock; i < block.number; i++){\n          this.latest10Blocks.push(this.web3.getBlock(i));\n        }\n\n        this.latest10Blocks = await Promise.all(this.latest10Blocks);\n      }\n\n      // Initial stats\n      this.latestBlockNumber = block.number;\n      this.latestGasPrice = gasPrice;\n      this.latestBlock = block;\n      this.latest10Blocks.push(block);\n\n      if(this.isWebsocketProvider){\n        this._initNewBlocksSubscription();\n      } else {\n        this.options.callInterval = this.options.callInterval || 1000;\n        this._initCallInterval();\n      }\n\n      resolve();\n    });\n  }\n\n  contract(contractInstance) {\n    if (!contractInstance) {\n      throw new Error(\"please pass a contract instance to Subspace.contract()\")\n    }\n\n    let address = (contractInstance.options && contractInstance.options.address) || contractInstance.address || contractInstance.deployedAddress;\n    let abi = (contractInstance.options && contractInstance.options.jsonInterface) || contractInstance.abi || contractInstance.abiDefinition;\n    let from = (contractInstance.options && contractInstance.options.from) || contractInstance.from || contractInstance.defaultAddress || this.web3.defaultAccount;\n    let gas = (contractInstance.options && contractInstance.options.gas) || contractInstance.gas || contractInstance.gas || \"800000\";\n\n    const SubspaceContract = new this.web3.Contract(abi, {from, gas});\n    SubspaceContract.options.address = address;\n    SubspaceContract.options.from = from;\n\n    if (!from) {\n      setTimeout(async () => {\n        const accounts = await this.web3.getAccounts();\n        SubspaceContract.options.from = accounts[0];\n      }, 100);\n    }\n\n    SubspaceContract.trackEvent = (eventName, filterConditionsOrCb) => {\n      return this.trackEvent(SubspaceContract, eventName, filterConditionsOrCb);\n    }\n\n    Object.keys(SubspaceContract.events).forEach(ev => {\n      if(!SubspaceContract.options.jsonInterface.find(x => x.type === 'event' && x.name == ev)) return;\n      SubspaceContract.events[ev].track = (filterConditionsOrCb) => this.trackEvent(SubspaceContract, ev, filterConditionsOrCb);\n    });\n\n    SubspaceContract.trackProperty = (propName, methodArgs, callArgs) => {\n      return this.trackProperty(SubspaceContract, propName, methodArgs, callArgs);\n    }\n\n    Object.keys(SubspaceContract.methods).forEach(methodName => {\n      const oldFunc = SubspaceContract.methods[methodName];\n\n      const _this = this;\n      const newFunc = function(){\n        const txObject = oldFunc.apply(null, arguments);\n        txObject.track = (callArgs) => _this.trackProperty(SubspaceContract, methodName, txObject.arguments, callArgs);\n        return txObject;\n      }\n\n      SubspaceContract.methods[methodName] = newFunc;\n    });\n\n    SubspaceContract.trackBalance = (erc20Address) => {\n      return this.trackBalance(SubspaceContract.options.address, erc20Address);\n    }\n\n    return SubspaceContract;\n  }\n\n  // TODO: get contract abi/address instead\n  trackEvent(contractInstance, eventName, filterConditions) {\n    const subjectHash = hash({address: contractInstance.options.address, networkId: this.networkId, eventName, filterConditions}); \n\n    if(this.subjects[subjectHash]) return this.subjects[subjectHash];\n\n    let deleteFrom = this.latestBlockNumber - this.options.refreshLastNBlocks;\n    let returnSub = this.eventSyncer.track(contractInstance, eventName, filterConditions, deleteFrom, this.networkId);\n\n    returnSub.map = (prop) => {\n      return returnSub.pipe(map((x) => {\n        if (typeof(prop) === \"string\") {\n          return x[prop];\n        }\n        if (Array.isArray(prop)) {\n          let newValues = {}\n          prop.forEach((p) => {\n            newValues[p] = x[p]\n          })\n          return newValues\n        }\n      }))\n    }\n\n    this.subjects[subjectHash] = returnSub;\n\n    return returnSub;\n  }\n\n  clearDB(collection) {\n    if (collection){\n      // TODO: delete specific collection\n    } else {\n      // TODO: delete everything\n    }\n  }\n\n  trackLogs(options, inputsABI) {\n    if(!this.isWebsocketProvider) console.warn(\"This method only works with websockets\");\n\n    const subjectHash = hash({inputsABI, options}); \n\n    if(this.subjects[subjectHash]) return this.subjects[subjectHash];\n\n    this.subjects[subjectHash] = this.logSyncer.track(options, inputsABI, this.latestBlockNumber - this.options.refreshLastNBlocks, this.networkId);\n    \n    return this.subjects[subjectHash];\n  }\n\n  _initNewBlocksSubscription() {\n    if (this.newBlocksSubscription != null || this.options.callInterval !== 0) return;\n   \n    this.newBlocksSubscription = this.web3.subscribe('newBlockHeaders', (err, result) => {\n      if (err) {\n        console.error(err);\n        return;\n      }\n\n      this.callables.forEach(fn => {\n        fn();\n      });\n    });\n  }\n\n  _initCallInterval() {\n    if (this.intervalTracker != null || this.options.callInterval === 0) return;\n\n    this.intervalTracker = setInterval(() => {\n      this.callables.forEach(fn => {\n        fn();\n      });\n    }, this.options.callInterval);\n  }\n\n  trackProperty(contractInstance, propName, methodArgs = [], callArgs = {}) {\n    const subjectHash = hash({address: contractInstance.options.address, networkId: this.networkId, propName, methodArgs, callArgs}); \n    \n    if(this.subjects[subjectHash]) return this.subjects[subjectHash];\n\n    const subject = new Subject();\n\n    if (!Array.isArray(methodArgs)) {\n      methodArgs = [methodArgs]\n    }\n\n    const method = contractInstance.methods[propName].apply(contractInstance.methods[propName], methodArgs);\n    \n    const callContractMethod = () => {\n      method.call.apply(method.call, [callArgs, (err, result) => {\n        if (err) {\n          subject.error(err);\n          return;\n        }\n        subject.next(result);\n      }]);\n    };\n\n    callContractMethod();\n\n    this.callables.push(callContractMethod);\n\n    const returnSub = subject.pipe(distinctUntilChanged((a, b) => equal(a, b)));\n\n    returnSub.map = (prop) => {\n      return returnSub.pipe(map((x) => {\n        if (typeof(prop) === \"string\") {\n          return x[prop];\n        }\n        if (Array.isArray(prop)) {\n          let newValues = {}\n          prop.forEach((p) => {\n            newValues[p] = x[p]\n          })\n          return newValues\n        }\n      }))\n    }\n\n    this.subjects[subjectHash] = returnSub;\n\n    return returnSub;\n  }\n\n  _addDistinctCallable(trackAttribute, cbBuilder, subject, subjectArg = undefined) {\n    if(this.subjects[trackAttribute]) return this.subjects[trackAttribute];\n    \n    const sub = new subject(subjectArg);\n\n    const cb = cbBuilder(sub);\n    cb();\n    this.callables.push(cb);\n\n    this.subjects[trackAttribute] = sub.pipe(distinctUntilChanged((a, b) => equal(a, b)));\n\n    return this.subjects[trackAttribute];\n  }\n\n  trackBlock() {\n    const blockCB = (subject) => () => {\n      this.web3.getBlock('latest').then(block => {\n        if(this.latest10Blocks[this.latest10Blocks.length - 1].number === block.number) return;\n\n        this.latest10Blocks.push(block);\n        if(this.latest10Blocks.length > 10){\n          this.latest10Blocks.shift();\n        }\n        subject.next(block);\n      }).catch(error => subject.error(error));\n    };\n    return this._addDistinctCallable('blockObservable', blockCB, BehaviorSubject, this.latestBlock);\n  }\n\n  trackBlockNumber() {\n    const blockNumberCB = (subject) => () => {\n      this.web3.getBlockNumber().then(blockNumber => subject.next(blockNumber)).catch(error => subject.error(error));\n    };\n    return this._addDistinctCallable('blockNumberObservable', blockNumberCB, BehaviorSubject, this.latestBlockNumber);\n  }\n\n  trackGasPrice() {\n    const gasPriceCB = (subject) => () => {\n      this.web3.getGasPrice().then(gasPrice => subject.next(gasPrice)).catch(error => subject.error(error));\n    };\n    return this._addDistinctCallable('gasPriceObservable', gasPriceCB, BehaviorSubject, this.latestGasPrice);\n  }\n\n  trackAverageBlocktime() {\n\n    this.trackBlock()\n\n    const avgTimeCB = (subject) => () => {\n      const times = [];\n      for (let i = 1; i < this.latest10Blocks.length; i++) {\n        let time = this.latest10Blocks[i].timestamp - this.latest10Blocks[i - 1].timestamp;\n        times.push(time)\n      }\n      const average = times.length ? Math.round(times.reduce((a, b) => a + b) / times.length) * 1000 : 0;\n      subject.next(average);\n    };\n    return this._addDistinctCallable('blockTimeObservable', avgTimeCB, BehaviorSubject, 123456);\n  }\n\n\n  trackBalance(address, erc20Address) {\n    const sub = new ReplaySubject();\n\n    if (!isAddress(address)) throw \"invalid address\"\n    if (erc20Address && !isAddress(erc20Address)) throw \"invalid ERC20 contract address\"\n\n    let callFn;\n    if (!erc20Address){\n      callFn = () => {\n        const fn  = this.web3.getBalance;\n\n        fn.apply(fn, [address, (err, balance) => {\n          if(err) {\n            sub.error(err);\n            return;\n          }\n          sub.next(balance);\n        }]);\n      };\n    } else {\n      callFn = () => {\n        const fn  = this.web3.call;\n                  //  balanceOf\n        const data = \"0x70a08231\" + \"000000000000000000000000\" + stripHexPrefix(address); \n        fn.apply(fn, [{to: erc20Address, data}, (err, result) => {\n          if (err) {\n            sub.error(err);\n            return;\n          }\n          sub.next(hexToDec(result));\n        }]);\n      };\n    }\n\n    // FIX ME: has issues immediatly getting the value\n    // this.web3.getBlock('latest').then(block => {\n    setTimeout(() => {\n      callFn();\n    }, 500);\n    // });\n\n    this.callables.push(callFn);\n\n    return sub.pipe(distinctUntilChanged((a, b) => equal(a, b)));\n  }\n\n  close(){\n    clearInterval(this.intervalTracker);\n    if (this.newBlocksSubscription) this.newBlocksSubscription.unsubscribe();\n    this.eventSyncer.close();\n    this.intervalTracker = null;\n    this.callables = [];\n  }\n\n}"],"file":"subspace.js"}