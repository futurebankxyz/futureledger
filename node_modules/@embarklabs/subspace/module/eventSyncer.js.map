{"version":3,"sources":["../src/eventSyncer.js"],"names":["fromEvent","ReplaySubject","hash","HttpEventScanner","WsEventScanner","EventSyncer","constructor","web3","events","db","isWebsocketProvider","eventKey","contractInstance","eventName","filters","fromBlock","toBlock","hardLimit","getPastEvents","cb","callbackFactory","ev","emit","storedEvents","getEventsFor","x","blockNumber","subscriptions","s","push","filterConditions","err","console","error","propsToFilter","prop","returnValues","eventScanner","track","gteBlockNum","networkId","address","options","deleteNewestBlocks","lastKnownBlock","getLastKnownEvent","firstKnownBlock","getFirstKnownEvent","sub","contractObserver","subscribe","e","complete","id","transactionIndex","logIndex","eventData","removed","next","deleteEvent","eventExists","recordEvent","fnDBEvents","serveDBEvents","fnPastEvents","fnSubscribe","subscribeToEvent","eth_subscribe","scan","og_subscribe","apply","add","then","susc","unsubscribe","close"],"mappings":";;;;;;AAAA,SAASA,SAAT,EAAoBC,aAApB,QAAyC,MAAzC;AACA,OAAOC,IAAP,MAAiB,aAAjB;AACA,OAAOC,gBAAP,MAA6B,oBAA7B;AACA,OAAOC,cAAP,MAA2B,kBAA3B;;AAEA,MAAMC,WAAN,CAAkB;AAEhBC,EAAAA,WAAW,CAACC,IAAD,EAAOC,OAAP,EAAeC,EAAf,EAAmBC,mBAAnB,EAAwC;AAAA,2CAiFnC,CAACC,QAAD,EAAWC,gBAAX,EAA6BC,SAA7B,EAAwCC,OAAxC,KAAoD,OAAOC,SAAP,EAAkBC,OAAlB,EAA2BC,SAA3B,KAAyC;AAC3G,UAAIT,MAAM,GAAG,MAAMI,gBAAgB,CAACM,aAAjB,CAA+BL,SAA/B,EAA0C,EAAE,GAAGC,OAAL;AAAcC,QAAAA,SAAd;AAAyBC,QAAAA;AAAzB,OAA1C,CAAnB;AACA,YAAMG,EAAE,GAAG,KAAKC,eAAL,CAAqBN,OAArB,EAA8BH,QAA9B,CAAX;;AAEA,+BAAAH,MAAM,MAAN,CAAAA,MAAM,EAASa,EAAE,IAAIF,EAAE,CAAC,IAAD,EAAOE,EAAP,CAAjB,CAAN;;AAEA,UAAGJ,SAAS,IAAID,OAAO,KAAKC,SAA5B,EAAsC;AAAE;AACtC,aAAKT,MAAL,CAAYc,IAAZ,CAAiBX,QAAjB;AACD;AACF,KA1FkD;;AAAA,2CA4FnCA,QAAQ,IAAI,CAACG,OAAD,EAAUE,OAAV,EAAmBD,SAAS,GAAG,IAA/B,KAAwC;AAAA;;AAClE,YAAMI,EAAE,GAAG,KAAKC,eAAL,CAAqBN,OAArB,EAA8BH,QAA9B,CAAX;;AACA,YAAMY,YAAY,GAAG,wCAAKd,EAAL,CAAQe,YAAR,CAAqBb,QAArB,kBAAsCc,CAAC,IAAIA,CAAC,CAACC,WAAF,KAAkBX,SAAS,IAAID,OAAO,CAACC,SAAvC,KAAqDU,CAAC,CAACC,WAAF,IAAiBV,OAAjH,CAArB;;AACA,+BAAAO,YAAY,MAAZ,CAAAA,YAAY,EAASF,EAAE,IAAI;AACzBF,QAAAA,EAAE,CAAC,IAAD,EAAOE,EAAP,CAAF;AACD,OAFW,CAAZ;AAGD,KAlGkD;;AAAA,8CAoGhC,CAACV,QAAD,EAAWC,gBAAX,EAA6BC,SAA7B,KAA2C,CAACc,aAAD,EAAgBb,OAAhB,KAA4B;AACxF,YAAMK,EAAE,GAAG,KAAKC,eAAL,CAAqBN,OAArB,EAA8BH,QAA9B,CAAX;AACA,YAAMiB,CAAC,GAAGhB,gBAAgB,CAACJ,MAAjB,CAAwBK,SAAxB,EAAmCC,OAAnC,EAA4CK,EAA5C,CAAV;AACAQ,MAAAA,aAAa,CAACE,IAAd,CAAmBD,CAAnB;AACA,aAAOA,CAAP;AACD,KAzGkD;;AAAA,6CA2GjC,CAACE,gBAAD,EAAmBnB,QAAnB,KAAgC,CAACoB,GAAD,EAAMV,EAAN,KAAa;AAC7D,UAAIU,GAAJ,EAAS;AACPC,QAAAA,OAAO,CAACC,KAAR,CAAcF,GAAd;AACA;AACD;;AAED,UAAID,gBAAJ,EAAsB;AACpB,YAAII,aAAa,GAAG,EAApB;;AACA,aAAK,IAAIC,IAAT,4BAAiBL,gBAAjB,GAA0C;AAAA;;AACxC,cAAI,kDAAYT,EAAE,CAACe,YAAf,mBAAqCD,IAArC,KAA8C,CAAlD,EAAqD;AACnDD,YAAAA,aAAa,CAACL,IAAd,CAAmBM,IAAnB;AACD;AACF;;AACD,aAAK,IAAIA,IAAT,IAAiBD,aAAjB,EAAgC;AAC9B,cAAI,wBAAAJ,gBAAgB,EAAQK,IAAR,CAAhB,KAAkCd,EAAE,CAACe,YAAH,CAAgBD,IAAhB,CAAtC,EAA6D;AAC9D;AACF;;AAED,WAAK3B,MAAL,CAAYc,IAAZ,CAAiBX,QAAjB,EAA2BU,EAA3B;AACD,KA9HkD;;AACjD,SAAKb,MAAL,GAAcA,OAAd;AACA,SAAKD,IAAL,GAAYA,IAAZ;AACA,SAAKE,EAAL,GAAUA,EAAV;AACA,SAAKC,mBAAL,GAA2BA,mBAA3B;AACA,SAAK2B,YAAL,GAAoB3B,mBAAmB,GAAG,IAAIN,cAAJ,CAAmBG,IAAnB,CAAH,GAA8B,IAAIJ,gBAAJ,CAAqBI,IAArB,CAArE;AACD;;AAED+B,EAAAA,KAAK,CAAC1B,gBAAD,EAAmBC,SAAnB,EAA8BC,OAA9B,EAAuCyB,WAAvC,EAAoDC,SAApD,EAA+D;AAClE,UAAM7B,QAAQ,GAAIT,IAAI,CAAC,eAAc;AAACuC,MAAAA,OAAO,EAAE7B,gBAAgB,CAAC8B,OAAjB,CAAyBD,OAAnC;AAA4CD,MAAAA;AAA5C,KAAd,EAAuE1B,OAAO,IAAI,EAAlF,CAAD,CAAtB;AAEA,SAAKL,EAAL,CAAQkC,kBAAR,CAA2BhC,QAA3B,EAAqC4B,WAArC;;AAEA,QAAIT,gBAAgB,GAAG,eAAc;AAACf,MAAAA,SAAS,EAAE,CAAZ;AAAeC,MAAAA,OAAO,EAAE;AAAxB,KAAd,EAAiDF,OAAO,IAAI,EAA5D,CAAvB;;AACA,QAAI8B,cAAc,GAAG,KAAKnC,EAAL,CAAQoC,iBAAR,CAA0BlC,QAA1B,CAArB;AACA,QAAImC,eAAe,GAAG,KAAKrC,EAAL,CAAQsC,kBAAR,CAA2BpC,QAA3B,CAAtB;AAGA,QAAIqC,GAAG,GAAG,IAAI/C,aAAJ,EAAV;AACA,QAAIgD,gBAAgB,GAAGjD,SAAS,CAAC,KAAKQ,MAAN,EAAcG,QAAd,CAAhC;AAEAsC,IAAAA,gBAAgB,CAACC,SAAjB,CAA4BC,CAAD,IAAO;AAChC,UAAI,CAACA,CAAL,EAAQ;AACNH,QAAAA,GAAG,CAACI,QAAJ;AACA;AACD;;AAED,YAAMC,EAAE,GAAGnD,IAAI,CAAC;AAACW,QAAAA,SAAD;AAAYa,QAAAA,WAAW,EAAEyB,CAAC,CAACzB,WAA3B;AAAwC4B,QAAAA,gBAAgB,EAAEH,CAAC,CAACG,gBAA5D;AAA8EC,QAAAA,QAAQ,EAAEJ,CAAC,CAACI;AAA1F,OAAD,CAAf,CANgC,CAQhC;;AACA,YAAMC,SAAS,GAAG;AAChBH,QAAAA,EADgB;AAEhBjB,QAAAA,YAAY,EAAE,EAAC,GAAGe,CAAC,CAACf;AAAN,SAFE;AAGhBV,QAAAA,WAAW,EAAEyB,CAAC,CAACzB,WAHC;AAIhB4B,QAAAA,gBAAgB,EAAEH,CAAC,CAACG,gBAJJ;AAKhBC,QAAAA,QAAQ,EAAEJ,CAAC,CAACI,QALI;AAMhBE,QAAAA,OAAO,EAAEN,CAAC,CAACM;AANK,OAAlB,CATgC,CAkBhC;;AACAT,MAAAA,GAAG,CAACU,IAAJ,CAAS;AAAChC,QAAAA,WAAW,EAAEyB,CAAC,CAACzB,WAAhB;AAA6B,WAAGyB,CAAC,CAACf;AAAlC,OAAT;;AAEA,UAAIe,CAAC,CAACM,OAAN,EAAc;AACZ,aAAKhD,EAAL,CAAQkD,WAAR,CAAoBhD,QAApB,EAA8B0C,EAA9B;AACA;AACD;;AAED,UAAI,KAAK5C,EAAL,CAAQmD,WAAR,CAAoBjD,QAApB,EAA8B6C,SAAS,CAACH,EAAxC,CAAJ,EAAiD;AAEjD,WAAK5C,EAAL,CAAQoD,WAAR,CAAoBlD,QAApB,EAA8B6C,SAA9B;AAEA,WAAKhD,MAAL,CAAYc,IAAZ,CAAiB,UAAjB;AACD,KA/BD;AAkCA,UAAMwC,UAAU,GAAG,KAAKC,aAAL,CAAmBpD,QAAnB,CAAnB;AACA,UAAMqD,YAAY,GAAG,KAAK9C,aAAL,CAAmBP,QAAnB,EAA6BC,gBAA7B,EAA+CC,SAA/C,EAA0DC,OAA1D,CAArB;;AAEA,QAAG,KAAKJ,mBAAR,EAA4B;AAC1B,YAAMuD,WAAW,GAAG,KAAKC,gBAAL,CAAsBvD,QAAtB,EAAgCC,gBAAhC,EAAkDC,SAAlD,CAApB;AACA,YAAMsD,aAAa,GAAG,KAAK9B,YAAL,CAAkB+B,IAAlB,CAAuBN,UAAvB,EAAmCE,YAAnC,EAAiDC,WAAjD,EAA8DnB,eAA9D,EAA+EF,cAA/E,EAA+Fd,gBAA/F,CAAtB;AAEA,YAAMuC,YAAY,GAAGrB,GAAG,CAACE,SAAzB;;AACAF,MAAAA,GAAG,CAACE,SAAJ,GAAgB,OAAOQ,IAAP,EAAazB,KAAb,EAAoBmB,QAApB,KAAiC;AAC/C,cAAMxB,CAAC,GAAGyC,YAAY,CAACC,KAAb,CAAmBtB,GAAnB,EAAwB,CAACU,IAAD,EAAOzB,KAAP,EAAcmB,QAAd,CAAxB,CAAV;AACAxB,QAAAA,CAAC,CAAC2C,GAAF,CAAM,MAAM;AAAE;AACZJ,UAAAA,aAAa,CAACK,IAAd,CAAmBC,IAAI,IAAI;AACzB,gBAAGA,IAAH,EAAS;AACPA,cAAAA,IAAI,CAACC,WAAL;AACD;AACF,WAJD;AAKD,SAND;AAOA,eAAO9C,CAAP;AACD,OAVD;AAWD,KAhBD,MAgBO;AACL,WAAKS,YAAL,CAAkB+B,IAAlB,CAAuBN,UAAvB,EAAmCE,YAAnC,EAAiDpB,cAAjD,EAAiEd,gBAAjE;AACD;;AAED,WAAOkB,GAAP;AACD;;AAiDD2B,EAAAA,KAAK,GAAE;AACL,SAAKtC,YAAL,CAAkBsC,KAAlB;AACD;;AApIe;;AAuIlB,eAAetE,WAAf","sourcesContent":["import { fromEvent, ReplaySubject } from 'rxjs';\nimport hash from 'object-hash';\nimport HttpEventScanner from './httpEventScanner';\nimport WsEventScanner from './wsEventScanner';\n\nclass EventSyncer {\n\n  constructor(web3, events, db, isWebsocketProvider) {\n    this.events = events;\n    this.web3 = web3;\n    this.db = db;\n    this.isWebsocketProvider = isWebsocketProvider;\n    this.eventScanner = isWebsocketProvider ? new WsEventScanner(web3) : new HttpEventScanner(web3);\n  }\n\n  track(contractInstance, eventName, filters, gteBlockNum, networkId) {\n    const eventKey =  hash(Object.assign({address: contractInstance.options.address, networkId}, (filters || {})));\n\n    this.db.deleteNewestBlocks(eventKey, gteBlockNum);\n\n    let filterConditions = Object.assign({fromBlock: 0, toBlock: \"latest\"}, filters || {});\n    let lastKnownBlock = this.db.getLastKnownEvent(eventKey);\n    let firstKnownBlock = this.db.getFirstKnownEvent(eventKey);\n\n\n    let sub = new ReplaySubject();\n    let contractObserver = fromEvent(this.events, eventKey)\n\n    contractObserver.subscribe((e) => {\n      if (!e) {\n        sub.complete();\n        return;\n      }\n\n      const id = hash({eventName, blockNumber: e.blockNumber, transactionIndex: e.transactionIndex, logIndex: e.logIndex});\n\n      // TODO: would be nice if this was smart enough to understand the type of returnValues and do the needed conversions\n      const eventData = {\n        id,\n        returnValues: {...e.returnValues},\n        blockNumber: e.blockNumber, \n        transactionIndex: e.transactionIndex, \n        logIndex: e.logIndex,\n        removed: e.removed\n      }\n\n      // TODO: test reorgs\n      sub.next({blockNumber: e.blockNumber, ...e.returnValues});\t\n\n      if (e.removed){\n        this.db.deleteEvent(eventKey, id);\n        return;\n      }\n\n      if (this.db.eventExists(eventKey, eventData.id)) return;\n\n      this.db.recordEvent(eventKey, eventData);\n\n      this.events.emit(\"updateDB\");\n    });\n\n\n    const fnDBEvents = this.serveDBEvents(eventKey);\n    const fnPastEvents = this.getPastEvents(eventKey, contractInstance, eventName, filters);\n\n    if(this.isWebsocketProvider){\n      const fnSubscribe = this.subscribeToEvent(eventKey, contractInstance, eventName);\n      const eth_subscribe = this.eventScanner.scan(fnDBEvents, fnPastEvents, fnSubscribe, firstKnownBlock, lastKnownBlock, filterConditions);\n\n      const og_subscribe = sub.subscribe;\n      sub.subscribe = async (next, error, complete) => {\n        const s = og_subscribe.apply(sub, [next, error, complete]);\n        s.add(() => { // Removing web3js subscription when rxJS unsubscribe is executed\n          eth_subscribe.then(susc => {\n            if(susc) {\n              susc.unsubscribe();\n            }\n          });\n        });\n        return s;\n      }\n    } else {\n      this.eventScanner.scan(fnDBEvents, fnPastEvents, lastKnownBlock, filterConditions);\n    }\n\n    return sub;\n  }\n\n  getPastEvents = (eventKey, contractInstance, eventName, filters) => async (fromBlock, toBlock, hardLimit) => { \n    let events = await contractInstance.getPastEvents(eventName, { ...filters, fromBlock, toBlock });  \n    const cb = this.callbackFactory(filters, eventKey);\n    \n    events.forEach(ev => cb(null, ev));\n\n    if(hardLimit && toBlock === hardLimit){ // Complete the observable\n      this.events.emit(eventKey);\n    }\n  }\n\n  serveDBEvents = eventKey => (filters, toBlock, fromBlock = null) => {\n    const cb = this.callbackFactory(filters, eventKey);\n    const storedEvents = this.db.getEventsFor(eventKey).filter(x => x.blockNumber >= (fromBlock || filters.fromBlock) && x.blockNumber <= toBlock);\n    storedEvents.forEach(ev => {\n      cb(null, ev);\n    });\n  }\n\n  subscribeToEvent = (eventKey, contractInstance, eventName) => (subscriptions, filters) => {\n    const cb = this.callbackFactory(filters, eventKey);\n    const s = contractInstance.events[eventName](filters, cb);\n    subscriptions.push(s);\n    return s;\n  }\n\n  callbackFactory = (filterConditions, eventKey) => (err, ev) => {\n    if (err) {\n      console.error(err);\n      return;\n    }\n\n    if (filterConditions) {\n      let propsToFilter = [];\n      for (let prop in filterConditions.filter) {\n        if (Object.keys(ev.returnValues).indexOf(prop) >= 0) {\n          propsToFilter.push(prop);\n        }\n      }\n      for (let prop of propsToFilter) {\n        if (filterConditions.filter[prop] !== ev.returnValues[prop]) return;\n      }\n    }\n\n    this.events.emit(eventKey, ev);\n  }\n\n  close(){\n    this.eventScanner.close();\n  }\n}\n\nexport default EventSyncer;\n"],"file":"eventSyncer.js"}