{"version":3,"sources":["../src/subspace.js"],"names":["ReplaySubject","BehaviorSubject","Subject","distinctUntilChanged","map","equal","Database","NullDatabase","Events","Web3Eth","isAddress","stripHexPrefix","hexToDec","EventSyncer","LogSyncer","hash","Subspace","provider","options","on","console","warn","events","web3","refreshLastNBlocks","callInterval","dbFilename","disableDatabase","networkId","undefined","isWebsocketProvider","disableSubscriptions","latestBlockNumber","latestGasPrice","latestBlock","latest10Blocks","subjects","newBlocksSubscription","intervalTracker","callables","resolve","reject","_db","eventSyncer","logSyncer","net","getId","then","netId","getBlock","block","getGasPrice","gasPrice","number","minBlock","Math","max","i","push","all","_initNewBlocksSubscription","_initCallInterval","contractInstance","Error","address","deployedAddress","abi","jsonInterface","abiDefinition","from","defaultAddress","defaultAccount","gas","SubspaceContract","Contract","getAccounts","accounts","trackEvent","eventName","filterConditionsOrCb","ev","x","type","name","track","trackProperty","propName","methodArgs","callArgs","methods","methodName","oldFunc","_this","newFunc","txObject","apply","arguments","trackBalance","erc20Address","filterConditions","subjectHash","deleteFrom","returnSub","prop","pipe","newValues","p","collection","inputsABI","subscribe","err","result","error","fn","subject","method","callContractMethod","call","next","a","b","trackAttribute","cbBuilder","subjectArg","sub","cb","blockCB","length","shift","catch","_addDistinctCallable","blockNumberCB","getBlockNumber","blockNumber","gasPriceCB","trackBlock","avgTimeCB","times","time","timestamp","average","round","callFn","getBalance","balance","data","to","clearInterval","unsubscribe","close"],"mappings":"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","sourcesContent":["import { ReplaySubject, BehaviorSubject, Subject } from 'rxjs';\nimport { distinctUntilChanged, map } from 'rxjs/operators';\nimport equal from 'fast-deep-equal';\nimport Database  from './database/database.js';\nimport NullDatabase  from './database/nullDatabase.js';\nimport Events from 'events';\nimport Web3Eth from 'web3-eth';\nimport {isAddress} from './utils';\nimport stripHexPrefix from 'strip-hex-prefix';\nimport {hexToDec} from 'hex2dec';\nimport EventSyncer from './eventSyncer';\nimport LogSyncer from './logSyncer';\nimport hash from 'object-hash';\n\nexport default class Subspace {\n\n  constructor(provider, options = {}) {\n    if (!provider.on) {\n      // https://github.com/ethereum/web3.js/blob/1.x/packages/web3-core-subscriptions/src/subscription.js#L205\n      console.warn(\"subspace: the current provider doesn't support subscriptions. Falling back to http polling\");\n    }\n\n    this.events = new Events();\n    this.web3 = new Web3Eth(provider);\n\n    this.options = {};\n    this.options.refreshLastNBlocks = options.refreshLastNBlocks || 12;\n    this.options.callInterval = options.callInterval || 0;\n    this.options.dbFilename = options.dbFilename || 'subspace.db';\n    this.disableDatabase = options.disableDatabase;\n    this.networkId = undefined;\n    this.isWebsocketProvider = options.disableSubscriptions ? false : !!provider.on;\n\n    // Stats\n    this.latestBlockNumber = undefined;\n    this.latestGasPrice = undefined;\n    this.latestBlock = undefined;\n    this.latest10Blocks = [];\n\n    this.subjects = {};\n\n    this.newBlocksSubscription = null;\n    this.intervalTracker = null;\n    this.callables = [];\n  }\n\n  init() {\n    return new Promise(async (resolve, reject) => {\n      if (this.disableDatabase === true) {\n        this._db = new NullDatabase(\"\", this.events);\n      } else {\n        this._db = new Database(this.options.dbFilename, this.events);\n      }\n      this.eventSyncer = new EventSyncer(this.web3, this.events, this._db, this.isWebsocketProvider);\n      this.logSyncer = new LogSyncer(this.web3, this.events, this._db);\n\n      this.web3.net.getId().then(netId => {\n        this.networkId = netId;\n      });\n\n\n      const block = await this.web3.getBlock('latest');\n      const gasPrice = await this.web3.getGasPrice();\n\n      // Preload <= 10 blocks to calculate avg block time\n      if(block.number !== 0){\n        const minBlock = Math.max(0, block.number - 9);\n        for(let i = minBlock; i < block.number; i++){\n          this.latest10Blocks.push(this.web3.getBlock(i));\n        }\n\n        this.latest10Blocks = await Promise.all(this.latest10Blocks);\n      }\n\n      // Initial stats\n      this.latestBlockNumber = block.number;\n      this.latestGasPrice = gasPrice;\n      this.latestBlock = block;\n      this.latest10Blocks.push(block);\n\n      if(this.isWebsocketProvider){\n        this._initNewBlocksSubscription();\n      } else {\n        this.options.callInterval = this.options.callInterval || 1000;\n        this._initCallInterval();\n      }\n\n      resolve();\n    });\n  }\n\n  contract(contractInstance) {\n    if (!contractInstance) {\n      throw new Error(\"please pass a contract instance to Subspace.contract()\")\n    }\n\n    let address = (contractInstance.options && contractInstance.options.address) || contractInstance.address || contractInstance.deployedAddress;\n    let abi = (contractInstance.options && contractInstance.options.jsonInterface) || contractInstance.abi || contractInstance.abiDefinition;\n    let from = (contractInstance.options && contractInstance.options.from) || contractInstance.from || contractInstance.defaultAddress || this.web3.defaultAccount;\n    let gas = (contractInstance.options && contractInstance.options.gas) || contractInstance.gas || contractInstance.gas || \"800000\";\n\n    const SubspaceContract = new this.web3.Contract(abi, {from, gas});\n    SubspaceContract.options.address = address;\n    SubspaceContract.options.from = from;\n\n    if (!from) {\n      setTimeout(async () => {\n        const accounts = await this.web3.getAccounts();\n        SubspaceContract.options.from = accounts[0];\n      }, 100);\n    }\n\n    SubspaceContract.trackEvent = (eventName, filterConditionsOrCb) => {\n      return this.trackEvent(SubspaceContract, eventName, filterConditionsOrCb);\n    }\n\n    Object.keys(SubspaceContract.events).forEach(ev => {\n      if(!SubspaceContract.options.jsonInterface.find(x => x.type === 'event' && x.name == ev)) return;\n      SubspaceContract.events[ev].track = (filterConditionsOrCb) => this.trackEvent(SubspaceContract, ev, filterConditionsOrCb);\n    });\n\n    SubspaceContract.trackProperty = (propName, methodArgs, callArgs) => {\n      return this.trackProperty(SubspaceContract, propName, methodArgs, callArgs);\n    }\n\n    Object.keys(SubspaceContract.methods).forEach(methodName => {\n      const oldFunc = SubspaceContract.methods[methodName];\n\n      const _this = this;\n      const newFunc = function(){\n        const txObject = oldFunc.apply(null, arguments);\n        txObject.track = (callArgs) => _this.trackProperty(SubspaceContract, methodName, txObject.arguments, callArgs);\n        return txObject;\n      }\n\n      SubspaceContract.methods[methodName] = newFunc;\n    });\n\n    SubspaceContract.trackBalance = (erc20Address) => {\n      return this.trackBalance(SubspaceContract.options.address, erc20Address);\n    }\n\n    return SubspaceContract;\n  }\n\n  // TODO: get contract abi/address instead\n  trackEvent(contractInstance, eventName, filterConditions) {\n    const subjectHash = hash({address: contractInstance.options.address, networkId: this.networkId, eventName, filterConditions}); \n\n    if(this.subjects[subjectHash]) return this.subjects[subjectHash];\n\n    let deleteFrom = this.latestBlockNumber - this.options.refreshLastNBlocks;\n    let returnSub = this.eventSyncer.track(contractInstance, eventName, filterConditions, deleteFrom, this.networkId);\n\n    returnSub.map = (prop) => {\n      return returnSub.pipe(map((x) => {\n        if (typeof(prop) === \"string\") {\n          return x[prop];\n        }\n        if (Array.isArray(prop)) {\n          let newValues = {}\n          prop.forEach((p) => {\n            newValues[p] = x[p]\n          })\n          return newValues\n        }\n      }))\n    }\n\n    this.subjects[subjectHash] = returnSub;\n\n    return returnSub;\n  }\n\n  clearDB(collection) {\n    if (collection){\n      // TODO: delete specific collection\n    } else {\n      // TODO: delete everything\n    }\n  }\n\n  trackLogs(options, inputsABI) {\n    if(!this.isWebsocketProvider) console.warn(\"This method only works with websockets\");\n\n    const subjectHash = hash({inputsABI, options}); \n\n    if(this.subjects[subjectHash]) return this.subjects[subjectHash];\n\n    this.subjects[subjectHash] = this.logSyncer.track(options, inputsABI, this.latestBlockNumber - this.options.refreshLastNBlocks, this.networkId);\n    \n    return this.subjects[subjectHash];\n  }\n\n  _initNewBlocksSubscription() {\n    if (this.newBlocksSubscription != null || this.options.callInterval !== 0) return;\n   \n    this.newBlocksSubscription = this.web3.subscribe('newBlockHeaders', (err, result) => {\n      if (err) {\n        console.error(err);\n        return;\n      }\n\n      this.callables.forEach(fn => {\n        fn();\n      });\n    });\n  }\n\n  _initCallInterval() {\n    if (this.intervalTracker != null || this.options.callInterval === 0) return;\n\n    this.intervalTracker = setInterval(() => {\n      this.callables.forEach(fn => {\n        fn();\n      });\n    }, this.options.callInterval);\n  }\n\n  trackProperty(contractInstance, propName, methodArgs = [], callArgs = {}) {\n    const subjectHash = hash({address: contractInstance.options.address, networkId: this.networkId, propName, methodArgs, callArgs}); \n    \n    if(this.subjects[subjectHash]) return this.subjects[subjectHash];\n\n    const subject = new Subject();\n\n    if (!Array.isArray(methodArgs)) {\n      methodArgs = [methodArgs]\n    }\n\n    const method = contractInstance.methods[propName].apply(contractInstance.methods[propName], methodArgs);\n    \n    const callContractMethod = () => {\n      method.call.apply(method.call, [callArgs, (err, result) => {\n        if (err) {\n          subject.error(err);\n          return;\n        }\n        subject.next(result);\n      }]);\n    };\n\n    callContractMethod();\n\n    this.callables.push(callContractMethod);\n\n    const returnSub = subject.pipe(distinctUntilChanged((a, b) => equal(a, b)));\n\n    returnSub.map = (prop) => {\n      return returnSub.pipe(map((x) => {\n        if (typeof(prop) === \"string\") {\n          return x[prop];\n        }\n        if (Array.isArray(prop)) {\n          let newValues = {}\n          prop.forEach((p) => {\n            newValues[p] = x[p]\n          })\n          return newValues\n        }\n      }))\n    }\n\n    this.subjects[subjectHash] = returnSub;\n\n    return returnSub;\n  }\n\n  _addDistinctCallable(trackAttribute, cbBuilder, subject, subjectArg = undefined) {\n    if(this.subjects[trackAttribute]) return this.subjects[trackAttribute];\n    \n    const sub = new subject(subjectArg);\n\n    const cb = cbBuilder(sub);\n    cb();\n    this.callables.push(cb);\n\n    this.subjects[trackAttribute] = sub.pipe(distinctUntilChanged((a, b) => equal(a, b)));\n\n    return this.subjects[trackAttribute];\n  }\n\n  trackBlock() {\n    const blockCB = (subject) => () => {\n      this.web3.getBlock('latest').then(block => {\n        if(this.latest10Blocks[this.latest10Blocks.length - 1].number === block.number) return;\n\n        this.latest10Blocks.push(block);\n        if(this.latest10Blocks.length > 10){\n          this.latest10Blocks.shift();\n        }\n        subject.next(block);\n      }).catch(error => subject.error(error));\n    };\n    return this._addDistinctCallable('blockObservable', blockCB, BehaviorSubject, this.latestBlock);\n  }\n\n  trackBlockNumber() {\n    const blockNumberCB = (subject) => () => {\n      this.web3.getBlockNumber().then(blockNumber => subject.next(blockNumber)).catch(error => subject.error(error));\n    };\n    return this._addDistinctCallable('blockNumberObservable', blockNumberCB, BehaviorSubject, this.latestBlockNumber);\n  }\n\n  trackGasPrice() {\n    const gasPriceCB = (subject) => () => {\n      this.web3.getGasPrice().then(gasPrice => subject.next(gasPrice)).catch(error => subject.error(error));\n    };\n    return this._addDistinctCallable('gasPriceObservable', gasPriceCB, BehaviorSubject, this.latestGasPrice);\n  }\n\n  trackAverageBlocktime() {\n\n    this.trackBlock()\n\n    const avgTimeCB = (subject) => () => {\n      const times = [];\n      for (let i = 1; i < this.latest10Blocks.length; i++) {\n        let time = this.latest10Blocks[i].timestamp - this.latest10Blocks[i - 1].timestamp;\n        times.push(time)\n      }\n      const average = times.length ? Math.round(times.reduce((a, b) => a + b) / times.length) * 1000 : 0;\n      subject.next(average);\n    };\n    return this._addDistinctCallable('blockTimeObservable', avgTimeCB, BehaviorSubject, 123456);\n  }\n\n\n  trackBalance(address, erc20Address) {\n    const sub = new ReplaySubject();\n\n    if (!isAddress(address)) throw \"invalid address\"\n    if (erc20Address && !isAddress(erc20Address)) throw \"invalid ERC20 contract address\"\n\n    let callFn;\n    if (!erc20Address){\n      callFn = () => {\n        const fn  = this.web3.getBalance;\n\n        fn.apply(fn, [address, (err, balance) => {\n          if(err) {\n            sub.error(err);\n            return;\n          }\n          sub.next(balance);\n        }]);\n      };\n    } else {\n      callFn = () => {\n        const fn  = this.web3.call;\n                  //  balanceOf\n        const data = \"0x70a08231\" + \"000000000000000000000000\" + stripHexPrefix(address); \n        fn.apply(fn, [{to: erc20Address, data}, (err, result) => {\n          if (err) {\n            sub.error(err);\n            return;\n          }\n          sub.next(hexToDec(result));\n        }]);\n      };\n    }\n\n    // FIX ME: has issues immediatly getting the value\n    // this.web3.getBlock('latest').then(block => {\n    setTimeout(() => {\n      callFn();\n    }, 500);\n    // });\n\n    this.callables.push(callFn);\n\n    return sub.pipe(distinctUntilChanged((a, b) => equal(a, b)));\n  }\n\n  close(){\n    clearInterval(this.intervalTracker);\n    if (this.newBlocksSubscription) this.newBlocksSubscription.unsubscribe();\n    this.eventSyncer.close();\n    this.intervalTracker = null;\n    this.callables = [];\n  }\n\n}"],"file":"subspace.js"}