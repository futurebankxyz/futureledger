{"version":3,"sources":["../src/subspace.js"],"names":["Subspace","constructor","provider","options","on","console","warn","events","Events","web3","Web3Eth","refreshLastNBlocks","callInterval","dbFilename","disableDatabase","networkId","undefined","isWebsocketProvider","disableSubscriptions","latestBlockNumber","latestGasPrice","latestBlock","latest10Blocks","subjects","newBlocksSubscription","intervalTracker","callables","init","resolve","reject","_db","NullDatabase","Database","eventSyncer","EventSyncer","logSyncer","LogSyncer","net","getId","then","netId","block","getBlock","gasPrice","getGasPrice","number","minBlock","Math","max","i","push","all","_initNewBlocksSubscription","_initCallInterval","contract","contractInstance","Error","address","deployedAddress","abi","jsonInterface","abiDefinition","from","defaultAddress","defaultAccount","gas","SubspaceContract","Contract","accounts","getAccounts","trackEvent","eventName","filterConditionsOrCb","ev","x","type","name","track","trackProperty","propName","methodArgs","callArgs","methods","methodName","oldFunc","_this","newFunc","txObject","apply","arguments","trackBalance","erc20Address","filterConditions","subjectHash","deleteFrom","returnSub","map","prop","pipe","newValues","p","clearDB","collection","trackLogs","inputsABI","subscribe","err","result","error","fn","subject","Subject","method","callContractMethod","call","next","a","b","_addDistinctCallable","trackAttribute","cbBuilder","subjectArg","sub","cb","trackBlock","blockCB","length","shift","catch","BehaviorSubject","trackBlockNumber","blockNumberCB","getBlockNumber","blockNumber","trackGasPrice","gasPriceCB","trackAverageBlocktime","avgTimeCB","times","time","timestamp","average","round","ReplaySubject","callFn","getBalance","balance","data","to","close","clearInterval","unsubscribe"],"mappings":"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","sourcesContent":["import { ReplaySubject, BehaviorSubject, Subject } from 'rxjs';\nimport { distinctUntilChanged, map } from 'rxjs/operators';\nimport equal from 'fast-deep-equal';\nimport Database  from './database/database.js';\nimport NullDatabase  from './database/nullDatabase.js';\nimport Events from 'events';\nimport Web3Eth from 'web3-eth';\nimport {isAddress} from './utils';\nimport stripHexPrefix from 'strip-hex-prefix';\nimport {hexToDec} from 'hex2dec';\nimport EventSyncer from './eventSyncer';\nimport LogSyncer from './logSyncer';\nimport hash from 'object-hash';\n\nexport default class Subspace {\n\n  constructor(provider, options = {}) {\n    if (!provider.on) {\n      // https://github.com/ethereum/web3.js/blob/1.x/packages/web3-core-subscriptions/src/subscription.js#L205\n      console.warn(\"subspace: the current provider doesn't support subscriptions. Falling back to http polling\");\n    }\n\n    this.events = new Events();\n    this.web3 = new Web3Eth(provider);\n\n    this.options = {};\n    this.options.refreshLastNBlocks = options.refreshLastNBlocks || 12;\n    this.options.callInterval = options.callInterval || 0;\n    this.options.dbFilename = options.dbFilename || 'subspace.db';\n    this.disableDatabase = options.disableDatabase;\n    this.networkId = undefined;\n    this.isWebsocketProvider = options.disableSubscriptions ? false : !!provider.on;\n\n    // Stats\n    this.latestBlockNumber = undefined;\n    this.latestGasPrice = undefined;\n    this.latestBlock = undefined;\n    this.latest10Blocks = [];\n\n    this.subjects = {};\n\n    this.newBlocksSubscription = null;\n    this.intervalTracker = null;\n    this.callables = [];\n  }\n\n  init() {\n    return new Promise(async (resolve, reject) => {\n      if (this.disableDatabase === true) {\n        this._db = new NullDatabase(\"\", this.events);\n      } else {\n        this._db = new Database(this.options.dbFilename, this.events);\n      }\n      this.eventSyncer = new EventSyncer(this.web3, this.events, this._db, this.isWebsocketProvider);\n      this.logSyncer = new LogSyncer(this.web3, this.events, this._db);\n\n      this.web3.net.getId().then(netId => {\n        this.networkId = netId;\n      });\n\n\n      const block = await this.web3.getBlock('latest');\n      const gasPrice = await this.web3.getGasPrice();\n\n      // Preload <= 10 blocks to calculate avg block time\n      if(block.number !== 0){\n        const minBlock = Math.max(0, block.number - 9);\n        for(let i = minBlock; i < block.number; i++){\n          this.latest10Blocks.push(this.web3.getBlock(i));\n        }\n\n        this.latest10Blocks = await Promise.all(this.latest10Blocks);\n      }\n\n      // Initial stats\n      this.latestBlockNumber = block.number;\n      this.latestGasPrice = gasPrice;\n      this.latestBlock = block;\n      this.latest10Blocks.push(block);\n\n      if(this.isWebsocketProvider){\n        this._initNewBlocksSubscription();\n      } else {\n        this.options.callInterval = this.options.callInterval || 1000;\n        this._initCallInterval();\n      }\n\n      resolve();\n    });\n  }\n\n  contract(contractInstance) {\n    if (!contractInstance) {\n      throw new Error(\"please pass a contract instance to Subspace.contract()\")\n    }\n\n    let address = (contractInstance.options && contractInstance.options.address) || contractInstance.address || contractInstance.deployedAddress;\n    let abi = (contractInstance.options && contractInstance.options.jsonInterface) || contractInstance.abi || contractInstance.abiDefinition;\n    let from = (contractInstance.options && contractInstance.options.from) || contractInstance.from || contractInstance.defaultAddress || this.web3.defaultAccount;\n    let gas = (contractInstance.options && contractInstance.options.gas) || contractInstance.gas || contractInstance.gas || \"800000\";\n\n    const SubspaceContract = new this.web3.Contract(abi, {from, gas});\n    SubspaceContract.options.address = address;\n    SubspaceContract.options.from = from;\n\n    if (!from) {\n      setTimeout(async () => {\n        const accounts = await this.web3.getAccounts();\n        SubspaceContract.options.from = accounts[0];\n      }, 100);\n    }\n\n    SubspaceContract.trackEvent = (eventName, filterConditionsOrCb) => {\n      return this.trackEvent(SubspaceContract, eventName, filterConditionsOrCb);\n    }\n\n    Object.keys(SubspaceContract.events).forEach(ev => {\n      if(!SubspaceContract.options.jsonInterface.find(x => x.type === 'event' && x.name == ev)) return;\n      SubspaceContract.events[ev].track = (filterConditionsOrCb) => this.trackEvent(SubspaceContract, ev, filterConditionsOrCb);\n    });\n\n    SubspaceContract.trackProperty = (propName, methodArgs, callArgs) => {\n      return this.trackProperty(SubspaceContract, propName, methodArgs, callArgs);\n    }\n\n    Object.keys(SubspaceContract.methods).forEach(methodName => {\n      const oldFunc = SubspaceContract.methods[methodName];\n\n      const _this = this;\n      const newFunc = function(){\n        const txObject = oldFunc.apply(null, arguments);\n        txObject.track = (callArgs) => _this.trackProperty(SubspaceContract, methodName, txObject.arguments, callArgs);\n        return txObject;\n      }\n\n      SubspaceContract.methods[methodName] = newFunc;\n    });\n\n    SubspaceContract.trackBalance = (erc20Address) => {\n      return this.trackBalance(SubspaceContract.options.address, erc20Address);\n    }\n\n    return SubspaceContract;\n  }\n\n  // TODO: get contract abi/address instead\n  trackEvent(contractInstance, eventName, filterConditions) {\n    const subjectHash = hash({address: contractInstance.options.address, networkId: this.networkId, eventName, filterConditions}); \n\n    if(this.subjects[subjectHash]) return this.subjects[subjectHash];\n\n    let deleteFrom = this.latestBlockNumber - this.options.refreshLastNBlocks;\n    let returnSub = this.eventSyncer.track(contractInstance, eventName, filterConditions, deleteFrom, this.networkId);\n\n    returnSub.map = (prop) => {\n      return returnSub.pipe(map((x) => {\n        if (typeof(prop) === \"string\") {\n          return x[prop];\n        }\n        if (Array.isArray(prop)) {\n          let newValues = {}\n          prop.forEach((p) => {\n            newValues[p] = x[p]\n          })\n          return newValues\n        }\n      }))\n    }\n\n    this.subjects[subjectHash] = returnSub;\n\n    return returnSub;\n  }\n\n  clearDB(collection) {\n    if (collection){\n      // TODO: delete specific collection\n    } else {\n      // TODO: delete everything\n    }\n  }\n\n  trackLogs(options, inputsABI) {\n    if(!this.isWebsocketProvider) console.warn(\"This method only works with websockets\");\n\n    const subjectHash = hash({inputsABI, options}); \n\n    if(this.subjects[subjectHash]) return this.subjects[subjectHash];\n\n    this.subjects[subjectHash] = this.logSyncer.track(options, inputsABI, this.latestBlockNumber - this.options.refreshLastNBlocks, this.networkId);\n    \n    return this.subjects[subjectHash];\n  }\n\n  _initNewBlocksSubscription() {\n    if (this.newBlocksSubscription != null || this.options.callInterval !== 0) return;\n   \n    this.newBlocksSubscription = this.web3.subscribe('newBlockHeaders', (err, result) => {\n      if (err) {\n        console.error(err);\n        return;\n      }\n\n      this.callables.forEach(fn => {\n        fn();\n      });\n    });\n  }\n\n  _initCallInterval() {\n    if (this.intervalTracker != null || this.options.callInterval === 0) return;\n\n    this.intervalTracker = setInterval(() => {\n      this.callables.forEach(fn => {\n        fn();\n      });\n    }, this.options.callInterval);\n  }\n\n  trackProperty(contractInstance, propName, methodArgs = [], callArgs = {}) {\n    const subjectHash = hash({address: contractInstance.options.address, networkId: this.networkId, propName, methodArgs, callArgs}); \n    \n    if(this.subjects[subjectHash]) return this.subjects[subjectHash];\n\n    const subject = new Subject();\n\n    if (!Array.isArray(methodArgs)) {\n      methodArgs = [methodArgs]\n    }\n\n    const method = contractInstance.methods[propName].apply(contractInstance.methods[propName], methodArgs);\n    \n    const callContractMethod = () => {\n      method.call.apply(method.call, [callArgs, (err, result) => {\n        if (err) {\n          subject.error(err);\n          return;\n        }\n        subject.next(result);\n      }]);\n    };\n\n    callContractMethod();\n\n    this.callables.push(callContractMethod);\n\n    const returnSub = subject.pipe(distinctUntilChanged((a, b) => equal(a, b)));\n\n    returnSub.map = (prop) => {\n      return returnSub.pipe(map((x) => {\n        if (typeof(prop) === \"string\") {\n          return x[prop];\n        }\n        if (Array.isArray(prop)) {\n          let newValues = {}\n          prop.forEach((p) => {\n            newValues[p] = x[p]\n          })\n          return newValues\n        }\n      }))\n    }\n\n    this.subjects[subjectHash] = returnSub;\n\n    return returnSub;\n  }\n\n  _addDistinctCallable(trackAttribute, cbBuilder, subject, subjectArg = undefined) {\n    if(this.subjects[trackAttribute]) return this.subjects[trackAttribute];\n    \n    const sub = new subject(subjectArg);\n\n    const cb = cbBuilder(sub);\n    cb();\n    this.callables.push(cb);\n\n    this.subjects[trackAttribute] = sub.pipe(distinctUntilChanged((a, b) => equal(a, b)));\n\n    return this.subjects[trackAttribute];\n  }\n\n  trackBlock() {\n    const blockCB = (subject) => () => {\n      this.web3.getBlock('latest').then(block => {\n        if(this.latest10Blocks[this.latest10Blocks.length - 1].number === block.number) return;\n\n        this.latest10Blocks.push(block);\n        if(this.latest10Blocks.length > 10){\n          this.latest10Blocks.shift();\n        }\n        subject.next(block);\n      }).catch(error => subject.error(error));\n    };\n    return this._addDistinctCallable('blockObservable', blockCB, BehaviorSubject, this.latestBlock);\n  }\n\n  trackBlockNumber() {\n    const blockNumberCB = (subject) => () => {\n      this.web3.getBlockNumber().then(blockNumber => subject.next(blockNumber)).catch(error => subject.error(error));\n    };\n    return this._addDistinctCallable('blockNumberObservable', blockNumberCB, BehaviorSubject, this.latestBlockNumber);\n  }\n\n  trackGasPrice() {\n    const gasPriceCB = (subject) => () => {\n      this.web3.getGasPrice().then(gasPrice => subject.next(gasPrice)).catch(error => subject.error(error));\n    };\n    return this._addDistinctCallable('gasPriceObservable', gasPriceCB, BehaviorSubject, this.latestGasPrice);\n  }\n\n  trackAverageBlocktime() {\n\n    this.trackBlock()\n\n    const avgTimeCB = (subject) => () => {\n      const times = [];\n      for (let i = 1; i < this.latest10Blocks.length; i++) {\n        let time = this.latest10Blocks[i].timestamp - this.latest10Blocks[i - 1].timestamp;\n        times.push(time)\n      }\n      const average = times.length ? Math.round(times.reduce((a, b) => a + b) / times.length) * 1000 : 0;\n      subject.next(average);\n    };\n    return this._addDistinctCallable('blockTimeObservable', avgTimeCB, BehaviorSubject, 123456);\n  }\n\n\n  trackBalance(address, erc20Address) {\n    const sub = new ReplaySubject();\n\n    if (!isAddress(address)) throw \"invalid address\"\n    if (erc20Address && !isAddress(erc20Address)) throw \"invalid ERC20 contract address\"\n\n    let callFn;\n    if (!erc20Address){\n      callFn = () => {\n        const fn  = this.web3.getBalance;\n\n        fn.apply(fn, [address, (err, balance) => {\n          if(err) {\n            sub.error(err);\n            return;\n          }\n          sub.next(balance);\n        }]);\n      };\n    } else {\n      callFn = () => {\n        const fn  = this.web3.call;\n                  //  balanceOf\n        const data = \"0x70a08231\" + \"000000000000000000000000\" + stripHexPrefix(address); \n        fn.apply(fn, [{to: erc20Address, data}, (err, result) => {\n          if (err) {\n            sub.error(err);\n            return;\n          }\n          sub.next(hexToDec(result));\n        }]);\n      };\n    }\n\n    // FIX ME: has issues immediatly getting the value\n    // this.web3.getBlock('latest').then(block => {\n    setTimeout(() => {\n      callFn();\n    }, 500);\n    // });\n\n    this.callables.push(callFn);\n\n    return sub.pipe(distinctUntilChanged((a, b) => equal(a, b)));\n  }\n\n  close(){\n    clearInterval(this.intervalTracker);\n    if (this.newBlocksSubscription) this.newBlocksSubscription.unsubscribe();\n    this.eventSyncer.close();\n    this.intervalTracker = null;\n    this.callables = [];\n  }\n\n}"],"file":"subspace.js"}